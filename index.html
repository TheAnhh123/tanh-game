<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√∫i M√π Tri Th·ª©c</title>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --bg-color: #f0f2f5;
            --text-color: #2d3436;
            --correct-color: #00b894;
            --wrong-color: #d63031;
            --timer-color: #fdcb6e;
            --bag-gradient: linear-gradient(135deg, #ff7675, #d63031);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            overflow-y: auto; 
            overflow-x: hidden;
        }

        /* --- Container chung --- */
        .container {
            width: 100%;
            max-width: 600px; 
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- M√†n h√¨nh Menu --- */
        #menu-screen {
            text-align: center;
            padding-bottom: 50px;
        }

        .hidden { display: none !important; }

        h1 {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin: 20px 0 10px 0;
            text-transform: uppercase;
            text-shadow: 2px 2px 0px #fff;
        }

        .subtitle {
            margin-bottom: 30px;
            font-size: 1rem;
            color: #636e72;
        }

        .subject-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn-subject {
            background: white;
            color: var(--text-color);
            border: none;
            padding: 20px;
            font-size: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            font-weight: bold;
            transition: transform 0.1s;
            text-align: left;
        }

        .btn-subject:active {
            transform: scale(0.98);
            background-color: #f1f2f6;
        }

        .btn-subject span {
            font-size: 2rem;
            width: 50px;
            text-align: center;
        }

        /* --- M√†n h√¨nh Game (T√∫i m√π) --- */
        #game-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header-sticky {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(240, 242, 245, 0.95);
            backdrop-filter: blur(5px);
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-back {
            background: #dfe6e9;
            color: var(--text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .score-board {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
            background: white;
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .bags-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding-bottom: 40px;
        }

        .bag {
            background: var(--bag-gradient);
            aspect-ratio: 1/1.2;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3rem;
            box-shadow: 0 5px 0 #b33939, 0 10px 15px rgba(0,0,0,0.1);
            position: relative;
            transition: transform 0.1s;
        }

        .bag:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #b33939;
        }

        .bag.opened {
            background: linear-gradient(135deg, var(--correct-color), #55efc4);
            box-shadow: 0 5px 0 #00896c;
        }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-1deg); }
            20%, 80% { transform: translate3d(2px, 0, 0) rotate(2deg); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-2deg); }
            40%, 60% { transform: translate3d(4px, 0, 0) rotate(2deg); }
        }

        /* --- Modal C√¢u h·ªèi (Full screen tr√™n mobile) --- */
        #quiz-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            z-index: 100;
            display: flex;
            flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s;
            transform: translateY(20px);
        }

        #quiz-modal.active {
            opacity: 1; pointer-events: all;
            transform: translateY(0);
        }

        /* Thanh th·ªùi gian */
        .timer-bar-container {
            width: 100%;
            height: 8px;
            background: #dfe6e9;
        }
        .timer-bar {
            height: 100%;
            background: var(--timer-color);
            width: 100%;
            transition: width 1s linear;
        }

        .quiz-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
        }

        .question-badge {
            background: var(--secondary-color);
            color: var(--primary-color);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            align-self: flex-start;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 40px;
            color: #2d3436;
            line-height: 1.5;
        }

        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn-option {
            background: #f1f2f6;
            border: 2px solid transparent;
            padding: 20px;
            border-radius: 15px;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: left;
            min-height: 60px;
            display: flex;
            align-items: center;
        }

        .btn-option:active { background: #dfe6e9; }
        .btn-option.correct { background: #55efc4; color: #006266; border-color: #00b894; }
        .btn-option.wrong { background: #fab1a0; color: #b33939; border-color: #d63031; }

        /* --- Loading Spinner --- */
        .loading-spinner-container {
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             padding: 50px 0;
        }
        .loading-spinner {
            border: 4px solid rgba(108, 92, 231, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Th√¥ng b√°o n·ªïi --- */
        #notification {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%) translateY(-150%);
            padding: 12px 30px;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 200;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        #notification.show { transform: translateX(-50%) translateY(0); }
        .notify-correct { background: #00b894; }
        .notify-wrong { background: #d63031; }

    </style>
</head>
<body>

    <div class="container">
        <!-- M√†n h√¨nh Menu -->
        <div id="menu-screen">
            <h1>üéí T√∫i M√π Tri Th·ª©c üéí</h1>
            <p class="subtitle">Ch·ªçn lƒ©nh v·ª±c ƒë·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi - 10s tr·∫£ l·ªùi!</p>
            
            <div class="subject-list">
                <button class="btn-subject" onclick="startGame('To√°n H·ªçc')"><span>üìê</span> To√°n H·ªçc</button>
                <button class="btn-subject" onclick="startGame('VƒÉn H·ªçc')"><span>üìö</span> VƒÉn H·ªçc</button>
                <button class="btn-subject" onclick="startGame('V·∫≠t L√Ω')"><span>‚öõÔ∏è</span> V·∫≠t L√Ω</button>
                <button class="btn-subject" onclick="startGame('H√≥a H·ªçc')"><span>üß™</span> H√≥a H·ªçc</button>
                <button class="btn-subject" onclick="startGame('Sinh H·ªçc')"><span>üß¨</span> Sinh H·ªçc</button>
                <button class="btn-subject" onclick="startGame('L·ªãch S·ª≠')"><span>‚öîÔ∏è</span> L·ªãch S·ª≠</button>
                <button class="btn-subject" onclick="startGame('ƒê·ªãa L√Ω')"><span>üåç</span> ƒê·ªãa L√Ω</button>
                <button class="btn-subject" onclick="startGame('Ti·∫øng Anh')"><span>üá¨üáß</span> Ti·∫øng Anh</button>
                <button class="btn-subject" onclick="startGame('Tin H·ªçc')"><span>üíª</span> Tin H·ªçc</button>
                <button class="btn-subject" onclick="startGame('GDCD')"><span>‚öñÔ∏è</span> GDCD</button>
            </div>
        </div>

        <!-- M√†n h√¨nh Game -->
        <div id="game-screen" class="hidden">
            <div class="header-sticky">
                <button class="btn-back" onclick="goBackMenu()">‚¨Ö Menu</button>
                <div class="score-board">ƒêi·ªÉm: <span id="score">0</span></div>
            </div>
            <h2 id="current-subject-title" style="text-align: center; margin-bottom: 20px;">...</h2>
            
            <div class="bags-container" id="bags-grid">
                <!-- T√∫i m√π s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
            </div>
        </div>
    </div>

    <!-- Modal C√¢u h·ªèi (Full screen) -->
    <div id="quiz-modal">
        <div class="timer-bar-container">
            <div id="timer-bar" class="timer-bar"></div>
        </div>
        <div class="quiz-content">
            <div class="question-badge" id="subject-badge">M√¥n h·ªçc</div>
            <div class="question-text" id="question-display">...</div>
            <div class="options-grid" id="options-display"></div>
        </div>
    </div>

    <div id="notification">Th√¥ng b√°o</div>

    <script>
        // API Configuration (API Key is provided by the environment)
        const API_KEY = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;

        // --- 1. H√ÄM T·∫†O C√ÇU H·ªéI TO√ÅN H·ªåC (Kh√¥ng d√πng API) ---
        function generateMathQuestion() {
            const types = ['+', '-', '*', '/'];
            const type = types[Math.floor(Math.random() * types.length)];
            let a, b, result, qStr, answers;

            // Logic sinh to√°n h·ªçc c∆° b·∫£n
            if (type === '+') {
                a = Math.floor(Math.random() * 50); b = Math.floor(Math.random() * 50);
                result = a + b; qStr = `${a} + ${b} = ?`;
            } else if (type === '-') {
                a = Math.floor(Math.random() * 50) + 20; b = Math.floor(Math.random() * 20);
                result = a - b; qStr = `${a} - ${b} = ?`;
            } else if (type === '*') {
                a = Math.floor(Math.random() * 12); b = Math.floor(Math.random() * 10);
                result = a * b; qStr = `${a} x ${b} = ?`;
            } else {
                b = Math.floor(Math.random() * 9) + 2; result = Math.floor(Math.random() * 10);
                a = b * result; qStr = `${a} : ${b} = ?`;
            }

            let wrong1 = result + Math.floor(Math.random() * 5) + 1;
            let wrong2 = result - Math.floor(Math.random() * 3) - 1;
            let wrong3 = result + 10;
            let initialAnswers = [result.toString(), wrong1.toString(), wrong2.toString(), wrong3.toString()];
            
            initialAnswers.sort(() => Math.random() - 0.5);

            // T√¨m index c·ªßa ƒë√°p √°n ƒë√∫ng (result)
            const correctIndex = initialAnswers.findIndex(ans => parseInt(ans) === result);

            return { q: qStr, a: initialAnswers, c: correctIndex };
        }

        // --- 2. H√ÄM G·ªåI API ƒê·ªÇ SINH C√ÇU H·ªéI TR·∫ÆC NGHI·ªÜM T·ª™ LLM ---
        async function fetchQuestionFromGemini(subject) {
            const systemPrompt = "B·∫°n l√† m·ªôt chuy√™n gia t·∫°o c√¢u h·ªèi tr·∫Øc nghi·ªám. H√£y t·∫°o m·ªôt c√¢u h·ªèi tr·∫Øc nghi·ªám v·ªÅ lƒ©nh v·ª±c " + subject + ". C√¢u h·ªèi ph·∫£i c√≥ 4 l·ª±a ch·ªçn (A, B, C, D) v√† ch·ªâ c√≥ M·ªòT ƒë√°p √°n ƒë√∫ng duy nh·∫•t. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát v√† tu√¢n th·ªß ƒë·ªãnh d·∫°ng JSON nghi√™m ng·∫∑t sau.";
            const userQuery = `T·∫°o m·ªôt c√¢u h·ªèi tr·∫Øc nghi·ªám m·ªõi v·ªÅ ${subject} ph√π h·ª£p cho h·ªçc sinh trung h·ªçc.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            q: { type: "STRING", description: "VƒÉn b·∫£n c√¢u h·ªèi." },
                            a: { type: "ARRAY", items: { type: "STRING" }, description: "M·∫£ng ch·ª©a 4 ƒë√°p √°n." },
                            c: { type: "INTEGER", description: "Ch·ªâ m·ª•c (index) c·ªßa ƒë√°p √°n ƒë√∫ng trong m·∫£ng 'a' (0, 1, 2, ho·∫∑c 3)." }
                        },
                        required: ["q", "a", "c"]
                    }
                }
            };

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Check for network/HTTP errors
                    if (!response.ok) {
                        throw new Error(`L·ªói HTTP: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        try {
                            const data = JSON.parse(text);
                            // Validate the structure
                            if (data.q && Array.isArray(data.a) && data.a.length === 4 && [0, 1, 2, 3].includes(data.c)) {
                                return data;
                            }
                            throw new Error("D·ªØ li·ªáu c√¢u h·ªèi kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.");
                        } catch (e) {
                            console.error("L·ªói ph√¢n t√≠ch JSON:", e, "Text nh·∫≠n ƒë∆∞·ª£c:", text);
                            throw new Error("Kh√¥ng th·ªÉ ƒë·ªçc c√¢u tr·∫£ l·ªùi t·ª´ m√°y ch·ªß.");
                        }
                    }
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung c√¢u h·ªèi.");

                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) {
                        // Throw the final error message
                        console.error("L·ªói g·ªçi API sau nhi·ªÅu l·∫ßn th·ª≠:", error);
                        throw new Error("L·ªói t·∫£i c√¢u h·ªèi. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i.");
                    }
                    // Exponential backoff delay
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- 3. LOGIC GAME & TIMER ---
        let currentSubject = '';
        let currentBagElement = null;
        let score = 0;
        let timerInterval;
        const TIME_LIMIT = 10;
        let isQuestionActive = false; 

        function startGame(subject) {
            currentSubject = subject;
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('current-subject-title').innerText = subject;
            window.scrollTo(0, 0);
            renderBags();
        }

        function goBackMenu() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
            clearInterval(timerInterval);
        }

        function renderBags() {
            const container = document.getElementById('bags-grid');
            container.innerHTML = ''; 
            for (let i = 0; i < 10; i++) {
                const bag = document.createElement('div');
                bag.className = 'bag';
                bag.innerHTML = '?';
                bag.onclick = function() { 
                    if (!this.classList.contains('opened') && !isQuestionActive) openBag(this); 
                };
                container.appendChild(bag);
            }
        }

        async function openBag(element) {
            currentBagElement = element;
            element.classList.add('shake');
            if (navigator.vibrate) navigator.vibrate(50);

            // Hi·ªán modal loading
            isQuestionActive = true;
            document.getElementById('subject-badge').innerText = currentSubject;
            document.getElementById('question-display').innerHTML = '<div class="loading-spinner-container"><div class="loading-spinner"></div><p style="text-align:center; margin-top: 10px;">ƒêang t·∫°o c√¢u h·ªèi...</p></div>';
            document.getElementById('options-display').innerHTML = '';
            document.getElementById('quiz-modal').classList.add('active');

            let questionData;
            
            try {
                if (currentSubject === 'To√°n H·ªçc') {
                    questionData = generateMathQuestion();
                } else {
                    questionData = await fetchQuestionFromGemini(currentSubject);
                }
                
                // Hi·ªÉn th·ªã c√¢u h·ªèi sau khi t·∫£i xong
                showQuestion(questionData);
            } catch (error) {
                console.error(error);
                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói th√¢n thi·ªán
                document.getElementById('question-display').innerHTML = `<div style="text-align:center; color: var(--wrong-color);">‚ö†Ô∏è ${error.message}</div>`;
                document.getElementById('options-display').innerHTML = '';
                
                // T·∫Øt modal sau 2s b√°o l·ªói
                setTimeout(() => {
                    document.getElementById('quiz-modal').classList.remove('active');
                    isQuestionActive = false;
                }, 2500);
            }
        }

        function showQuestion(questionData) {
            // Hi·ªÉn th·ªã n·ªôi dung
            document.getElementById('question-display').innerText = questionData.q;
            
            const optionsDiv = document.getElementById('options-display');
            optionsDiv.innerHTML = '';

            questionData.a.forEach((ans, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn-option';
                // S·ª≠ d·ª•ng innerHTML ƒë·ªÉ h·ªó tr·ª£ hi·ªÉn th·ªã c√°c k√Ω t·ª± to√°n h·ªçc (n·∫øu c√≥)
                btn.innerHTML = ans; 
                btn.onclick = () => answerSelected(btn, index, questionData.c);
                optionsDiv.appendChild(btn);
            });
            
            // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
            startTimer(questionData.c);
        }

        function startTimer(correctIndex) {
            let timeLeft = TIME_LIMIT;
            const bar = document.getElementById('timer-bar');
            bar.style.width = '100%';
            bar.style.backgroundColor = varCssValue('--timer-color');
            
            bar.style.transition = 'none';
            bar.offsetHeight; 
            bar.style.transition = 'width 10s linear, background-color 1s linear';
            
            bar.style.width = '0%';
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                
                if (timeLeft === 3) {
                    bar.style.backgroundColor = varCssValue('--wrong-color');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timeOut(correctIndex);
                }
            }, 1000);
        }

        function varCssValue(variable) {
            // L·∫•y gi√° tr·ªã bi·∫øn CSS ƒë·ªÉ s·ª≠ d·ª•ng trong JS
            return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
        }

        function timeOut(correctIndex) {
            showNotification("‚è∞ H·∫øt gi·ªù!", "wrong");
            if (navigator.vibrate) navigator.vibrate(200);
            
            const allBtns = document.querySelectorAll('.btn-option');
            allBtns.forEach(b => b.disabled = true);
            
            if (correctIndex !== undefined && allBtns[correctIndex]) {
                 allBtns[correctIndex].classList.add('correct');
            }

            setTimeout(() => {
                closeModalAndResetBag(false);
            }, 1500);
        }

        function answerSelected(btnElement, selected, correct) {
            clearInterval(timerInterval);
            
            const allBtns = document.querySelectorAll('.btn-option');
            allBtns.forEach(b => b.disabled = true);

            if (selected === correct) {
                btnElement.classList.add('correct');
                showNotification("üéâ Ch√≠nh x√°c!", "correct");
                score += 10;
                document.getElementById('score').innerText = score;

                setTimeout(() => {
                    closeModalAndResetBag(true);
                }, 1000);
            } else {
                btnElement.classList.add('wrong');
                allBtns[correct].classList.add('correct');
                showNotification("‚ùå Sai r·ªìi!", "wrong");
                if (navigator.vibrate) navigator.vibrate(200);

                setTimeout(() => {
                    closeModalAndResetBag(false);
                }, 1500);
            }
        }

        function closeModalAndResetBag(isCorrect) {
            document.getElementById('quiz-modal').classList.remove('active');
            isQuestionActive = false;
            
            if(isCorrect && currentBagElement) {
                currentBagElement.classList.add('opened');
                currentBagElement.innerHTML = '‚úì';
                
                setTimeout(() => {
                    currentBagElement.classList.remove('opened');
                    currentBagElement.innerHTML = '?';
                }, 2000);
            }
        }

        function showNotification(msg, type) {
            const notify = document.getElementById('notification');
            notify.innerText = msg;
            notify.className = ''; 
            notify.classList.add(type === 'correct' ? 'notify-correct' : 'notify-wrong');
            notify.classList.add('show');

            setTimeout(() => {
                notify.classList.remove('show');
            }, 1500);
        }
    </script>
</body>
</html>